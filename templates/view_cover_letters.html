<!-- templates/view_cover_letters.html -->
{% extends "base.html" %}
{% block title %}My Cover Letters - SmartCareer{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
  <div class="text-center mb-10">
    <h1 class="text-3xl font-extrabold text-gray-900">ðŸ“¬ My Cover Letters</h1>
    <p class="mt-2 text-lg text-gray-600">Manage your generated cover letters</p>
  </div>

  {% if cover_letters %}
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for letter in cover_letters %}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ letter.job_title }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ letter.company_info or "N/A" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ letter.created_at.strftime('%b %d, %Y') }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="viewLetter({{ letter.id }})" class="text-indigo-600 hover:text-indigo-900 mr-4">View</button>
                <a href="{{ url_for('delete_cover_letter', letter_id=letter.id) }}" class="text-red-600 hover:text-red-900">Delete</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center py-10">
      <p class="text-gray-500">You haven't generated any cover letters yet.</p>
      <a href="{{ url_for('cover_letter') }}" class="mt-4 inline-block px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Create One</a>
    </div>
  {% endif %}
</div>

<!-- View Modal -->
<div id="letter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full max-h-96 overflow-auto p-6 relative">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">&times;</button>
    <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
    <pre id="modal-content" class="whitespace-pre-wrap text-gray-800 leading-relaxed"></pre>
    <div class="mt-6 text-right">
      <button onclick="downloadModalAs('txt')" class="mr-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Download TXT</button>
      <!-- <button onclick="downloadModalAs('pdf')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Download PDF</button> -->
    </div>
  </div>
</div>

<script>
function viewLetter(id) {
  fetch(`/cover-letter/view/${id}`)
    .then(r => r.json())
    .then(data => {
      document.getElementById('modal-title').textContent = data.job_title;
      document.getElementById('modal-content').textContent = data.content;
      document.getElementById('letter-modal').classList.remove('hidden');
    });
}

function closeModal() {
  document.getElementById('letter-modal').classList.add('hidden');
}

function downloadModalAs(type) {
  const text = document.getElementById('modal-content').textContent;
  const filename = "cover-letter." + type;
  const blob = new Blob([text], { type: type === 'txt' ? 'text/plain' : 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
{% endblock %}